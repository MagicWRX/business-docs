– MXN_SUPABASE_SCHEMA.sql
– Date: 2025-12-06 06:00 (-06:00)
– Single Source of Truth: Full Supabase schema for MXN.CHAT (Project A) and MagicWRX (Project B)

⸻

– PROJECT A: MXN.CHAT DATABASE SCHEMA

– Profiles table
create table public.profiles (
id uuid primary key references auth.users(id),
display_name text,
avatar_url text,
created_at timestamptz default now()
);

– Conversations table
create table public.conversations (
id uuid primary key default gen_random_uuid(),
owner_id uuid references public.profiles(id),
title text,
is_private boolean default true,
created_at timestamptz default now()
);

– Conversation members
create table public.conversation_members (
conversation_id uuid references public.conversations(id) on delete cascade,
user_id uuid references public.profiles(id),
role text default ‘member’,
joined_at timestamptz default now(),
primary key (conversation_id, user_id)
);

– Messages table
create table public.messages (
id bigint generated by default as identity primary key,
conversation_id uuid references public.conversations(id) on delete cascade,
sender_id uuid references public.profiles(id),
content text,
content_plain text,
content_type text default ‘text’, – ‘text’ | ‘image’ | ‘system’
created_at timestamptz default now(),
edited_at timestamptz,
is_deleted boolean default false
);

– Attachments table
create table public.attachments (
id uuid primary key default gen_random_uuid(),
message_id bigint references public.messages(id) on delete set null,
bucket text,
path text,
content_type text,
size_bytes int,
uploaded_at timestamptz default now()
);

– Invitations table (for email invitations)
create table public.invitations (
id uuid primary key default gen_random_uuid(),
token text unique not null,
sender_id uuid references public.profiles(id),
recipient_email text not null,
conversation_id uuid references public.conversations(id),
personal_message text,
status text default 'pending', -- 'pending', 'accepted', 'expired', 'declined'
created_at timestamptz default now(),
expires_at timestamptz default (now() + interval '7 days'),
accepted_at timestamptz
);

– Indexes for messages
create index on public.messages (conversation_id, created_at desc);

– Enable RLS for messages
alter table public.messages enable row level security;

– Policies example for messages
create policy “select_messages_if_member” on public.messages
for select using (
exists (
select 1 from public.conversation_members cm
where cm.conversation_id = messages.conversation_id
and cm.user_id = auth.uid()
)
);

create policy “update_own_message_within_10min” on public.messages
for update using (
sender_id = auth.uid() and (now() - created_at) < interval ‘10 minutes’
);

create policy “insert_if_member” on public.messages
for insert with check (
exists (
select 1 from public.conversation_members cm
where cm.conversation_id = new.conversation_id
and cm.user_id = auth.uid()
)
);

– Enable RLS for invitations
alter table public.invitations enable row level security;

– Policies for invitations
create policy “users_can_create_invitations” on public.invitations
for insert with check (sender_id = auth.uid());

create policy “users_can_view_own_invitations” on public.invitations
for select using (sender_id = auth.uid() or recipient_email = (select email from auth.users where id = auth.uid()));

create policy “users_can_update_own_invitations” on public.invitations
for update using (sender_id = auth.uid());

⸻

– PROJECT B: MagicWRX DATABASE SCHEMA

– Users table
create table public.users (
id uuid primary key references auth.users(id),
display_name text,
plan text default ‘free’,
created_at timestamptz default now()
);

– Sites table
create table public.sites (
id uuid primary key default gen_random_uuid(),
owner_id uuid references public.users(id),
domain text,
title text,
description text,
created_at timestamptz default now(),
plan text default ‘free’,
page_count int default 1
);

– Pages table
create table public.pages (
id uuid primary key default gen_random_uuid(),
site_id uuid references public.sites(id) on delete cascade,
slug text,
body jsonb,
updated_at timestamptz default now()
);

– Products table
create table public.products (
id uuid primary key default gen_random_uuid(),
site_id uuid references public.sites(id) on delete cascade,
title text,
description text,
price_cents int,
currency text default ‘USD’,
inventory int default 1,
created_at timestamptz default now()
);

– Orders table
create table public.orders (
id uuid primary key default gen_random_uuid(),
product_id uuid references public.products(id),
buyer_email text,
stripe_payment_id text,
amount_cents int,
status text,
created_at timestamptz default now()
);

– Analytics table (pageviews)
create table public.pageviews (
id bigint generated by default as identity primary key,
site_id uuid references public.sites(id) on delete cascade,
path text,
referer text,
user_agent text,
created_at timestamptz default now()
);

create index on public.pageviews (site_id, created_at desc);

– User quotas table
create table public.user_quotas (
user_id uuid primary key references auth.users(id),
storage_bytes_allowed bigint default 104857600, – 100MB
storage_bytes_used bigint default 0
);

– Enable RLS for MagicWRX
alter table public.sites enable row level security;
alter table public.pages enable row level security;
alter table public.products enable row level security;
alter table public.orders enable row level security;

– Policies (example: site owner can only access own sites)
create policy “sites_owner_access” on public.sites
for all using (owner_id = auth.uid());

create policy “pages_owner_access” on public.pages
for all using (
exists (select 1 from public.sites s where s.id = pages.site_id and s.owner_id = auth.uid())
);

create policy “products_owner_access” on public.products
for all using (
exists (select 1 from public.sites s where s.id = products.site_id and s.owner_id = auth.uid())
);

create policy “orders_owner_access” on public.orders
for all using (
exists (select 1 from public.products p join public.sites s on p.site_id = s.id where p.id = orders.product_id and s.owner_id = auth.uid())
);

– End of MXN Supabase Schema