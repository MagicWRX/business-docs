import React, { useState } from 'react';
import { Layout, LayoutSection, LayoutColumn, LayoutElement, COLUMN_PRESETS, ColumnPresetType } from '../types';

export interface LayoutManagerProps {
  initialLayout?: Layout;
  onSave?: (layout: Layout) => void;
  onChange?: (layout: Layout) => void;
}

export const LayoutManager: React.FC<LayoutManagerProps> = ({ initialLayout, onSave, onChange }) => {
  const [layout, setLayout] = useState<Layout>(initialLayout || {
    id: crypto.randomUUID(),
    name: 'New Layout',
    sections: [],
    created: new Date().toISOString(),
    lastModified: new Date().toISOString()
  });

  const [selectedSectionId, setSelectedSectionId] = useState<string | null>(null);

  const addSection = () => {
    const newSection: LayoutSection = {
      id: crypto.randomUUID(),
      name: `Section ${layout.sections.length + 1}`,
      type: 'container',
      columns: [{ id: crypto.randomUUID(), width: '100%', elements: [] }]
    };
    
    updateLayout({
      ...layout,
      sections: [...layout.sections, newSection]
    });
  };

  const updateSectionColumns = (sectionId: string, preset: ColumnPresetType) => {
    const sectionIndex = layout.sections.findIndex(s => s.id === sectionId);
    if (sectionIndex === -1) return;

    const newColumns = COLUMN_PRESETS[preset].map(colConfig => ({
      id: crypto.randomUUID(),
      width: colConfig.width,
      elements: []
    }));

    const updatedSections = [...layout.sections];
    updatedSections[sectionIndex] = {
      ...updatedSections[sectionIndex],
      columns: newColumns
    };

    updateLayout({ ...layout, sections: updatedSections });
  };

  const addElementToColumn = (sectionId: string, columnId: string, type: string) => {
    const sectionIndex = layout.sections.findIndex(s => s.id === sectionId);
    if (sectionIndex === -1) return;

    const columnIndex = layout.sections[sectionIndex].columns.findIndex(c => c.id === columnId);
    if (columnIndex === -1) return;

    const newElement: LayoutElement = {
      id: crypto.randomUUID(),
      type,
      content: {}
    };

    const updatedSections = [...layout.sections];
    const updatedColumn = { ...updatedSections[sectionIndex].columns[columnIndex] };
    updatedColumn.elements = [...updatedColumn.elements, newElement];
    updatedSections[sectionIndex].columns[columnIndex] = updatedColumn;

    updateLayout({ ...layout, sections: updatedSections });
  };

  const updateLayout = (newLayout: Layout) => {
    const updated = { ...newLayout, lastModified: new Date().toISOString() };
    setLayout(updated);
  };

  return (
    <div className="flex h-full bg-gray-100">
      {/* Sidebar Controls */}
      <div className="w-64 bg-white border-r p-4 flex flex-col gap-4 overflow-y-auto">
        <div>
          <h2 className="font-bold text-lg mb-2">Layout Structure</h2>
          <button 
            onClick={addSection}
            className="w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            + Add Section
          </button>
        </div>

        {selectedSectionId && (
          <div className="border-t pt-4">
            <h3 className="font-semibold mb-2">Column Layout</h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.keys(COLUMN_PRESETS).map((preset) => (
                <button
                  key={preset}
                  onClick={() => updateSectionColumns(selectedSectionId, preset as ColumnPresetType)}
                  className="p-2 text-xs border rounded hover:bg-gray-50 text-center"
                >
                  {preset}
                </button>
              ))}
            </div>
          </div>
        )}

        <div className="mt-auto pt-4 border-t">
          <button
            onClick={() => onSave?.(layout)}
            className="w-full py-2 px-4 bg-green-600 text-white rounded hover:bg-green-700"
          >
            Save Layout
          </button>
        </div>
      </div>

      {/* Main Canvas */}
      <div className="flex-1 p-8 overflow-y-auto">
        <div className="max-w-5xl mx-auto space-y-4">
          {layout.sections.length === 0 ? (
            <div className="text-center py-20 text-gray-400 border-2 border-dashed border-gray-300 rounded-lg">
              <p className="text-xl">Empty Layout</p>
              <p>Click "Add Section" to start building</p>
            </div>
          ) : (
            layout.sections.map((section) => (
              <div 
                key={section.id}
                onClick={() => setSelectedSectionId(section.id)}
                className={`bg-white rounded-lg shadow-sm border-2 transition-all ${
                  selectedSectionId === section.id ? 'border-blue-500 ring-2 ring-blue-100' : 'border-transparent hover:border-gray-300'
                }`}
              >
                {/* Section Header */}
                <div className="px-4 py-2 border-b bg-gray-50 flex justify-between items-center rounded-t-lg">
                  <span className="font-medium text-gray-700">{section.name}</span>
                  <div className="text-xs text-gray-500">
                    {section.columns.length} Columns
                  </div>
                </div>

                {/* Columns Container */}
                <div className="p-4 flex gap-4">
                  {section.columns.map((column) => (
                    <div 
                      key={column.id}
                      style={{ width: column.width }}
                      className="min-h-[100px] bg-gray-50 border border-dashed border-gray-300 rounded p-2 flex flex-col gap-2"
                    >
                      {/* Elements */}
                      {column.elements.map((element) => (
                        <div key={element.id} className="bg-white p-3 border rounded shadow-sm text-sm">
                          {element.type}
                        </div>
                      ))}
                      
                      {/* Add Element Button */}
                      <div className="mt-auto pt-2 flex justify-center gap-2">
                        <button 
                          onClick={(e) => { e.stopPropagation(); addElementToColumn(section.id, column.id, 'text'); }}
                          className="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-50"
                        >
                          + Text
                        </button>
                        <button 
                          onClick={(e) => { e.stopPropagation(); addElementToColumn(section.id, column.id, 'image'); }}
                          className="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-50"
                        >
                          + Img
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

